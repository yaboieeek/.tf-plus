name: Discord Notifications

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, closed, merged]
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          since_last_remote_commit: true
      
      - name: Send Discord notifications
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          FILES_LIST="${{ steps.changed-files.outputs.all_changed_files }}"
          
          IFS=' ' read -ra FILES_ARRAY <<< "$FILES_LIST"
          
          for file_path in "${FILES_ARRAY[@]}"; do
            if [[ -n "$file_path" ]]; then
              # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· Ð¿ÑƒÑ‚Ð¸
              FILENAME=$(basename "$file_path")
              
              TITLE="Updated: $FILENAME"
              
              DESCRIPTION=""
              if [[ "${{ github.event_name }}" == "push" ]]; then
                DESCRIPTION="${{ github.event.head_commit.message }}"
              elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
                DESCRIPTION="PR ${{ github.event.action }}: ${{ github.event.pull_request.title }}"
              elif [[ "${{ github.event_name }}" == "release" ]]; then
                DESCRIPTION="New release: ${{ github.event.release.name }}"
              fi
              
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{
                     \"content\": \"ðŸ—£ File updated in ${{ github.repository }}!\",
                     \"embeds\": [{
                       \"title\": \"$TITLE\",
                       \"description\": \"$DESCRIPTION\",
                       \"color\": 5814783,
                       \"fields\": [
                         {\"name\": \"File\", \"value\": \"\`$file_path\`\", \"inline\": false},
                         {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                         {\"name\": \"Author\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                       ],
                       \"timestamp\": \"${{ github.event.head_commit.timestamp || github.event.pull_request.created_at || github.event.release.created_at }}\"
                     }]
                   }" \
                   $DISCORD_WEBHOOK_URL || echo "Failed to send notification for $file_path"
            fi
          done
