name: Discord Notifications

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, closed, merged]
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          since_last_remote_commit: true
      
      - name: Send Discord notifications
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è JSON
          json_escape() {
            echo "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/\//\\\//g' -e 's/\n/\\n/g' -e 's/\r/\\r/g' -e 's/\t/\\t/g'
          }
          
          # –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤
          FILES_LIST="${{ steps.changed-files.outputs.all_changed_files }}"
          
          # –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤
          IFS=' ' read -ra FILES_ARRAY <<< "$FILES_LIST"
          
          # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          REPO_NAME=$(json_escape "${{ github.repository }}")
          BRANCH_NAME=$(json_escape "${{ github.ref_name }}")
          AUTHOR_NAME=$(json_escape "${{ github.actor }}")
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –¥–ª—è –ö–ê–ñ–î–û–ì–û —Ñ–∞–π–ª–∞
          for file_path in "${FILES_ARRAY[@]}"; do
            if [[ -n "$file_path" ]]; then
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø—É—Ç–∏ –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º
              FILENAME=$(json_escape "$(basename "$file_path")")
              FILEPATH_ESCAPED=$(json_escape "$file_path")
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞
              TITLE="Updated: $FILENAME"
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
              DESCRIPTION=""
              if [[ "${{ github.event_name }}" == "push" ]]; then
                COMMIT_MSG=$(json_escape "${{ github.event.head_commit.message }}")
                DESCRIPTION="$COMMIT_MSG"
                TIMESTAMP="${{ github.event.head_commit.timestamp }}"
              elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
                PR_TITLE=$(json_escape "${{ github.event.pull_request.title }}")
                DESCRIPTION="PR ${{ github.event.action }}: $PR_TITLE"
                TIMESTAMP="${{ github.event.pull_request.created_at }}"
              elif [[ "${{ github.event_name }}" == "release" ]]; then
                RELEASE_NAME=$(json_escape "${{ github.event.release.name }}")
                DESCRIPTION="New release: $RELEASE_NAME"
                TIMESTAMP="${{ github.event.release.created_at }}"
              fi
              
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º JSON
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{
                    \"content\": \"üó£ File updated in $REPO_NAME!\",
                    \"embeds\": [{
                      \"title\": \"$TITLE\",
                      \"description\": \"$DESCRIPTION\",
                      \"color\": 5814783,
                      \"fields\": [
                        {\"name\": \"File\", \"value\": \"\`$FILEPATH_ESCAPED\`\", \"inline\": false},
                        {\"name\": \"Branch\", \"value\": \"$BRANCH_NAME\", \"inline\": true},
                        {\"name\": \"Author\", \"value\": \"$AUTHOR_NAME\", \"inline\": true}
                      ],
                      \"timestamp\": \"$TIMESTAMP\"
                    }]
                  }" \
                   $DISCORD_WEBHOOK_URL || echo "Failed to send notification for $file_path"
            fi
          done
