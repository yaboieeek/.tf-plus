name: Discord Notifications

on:
  push:
    branches: [ main, master ]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          since_last_remote_commit: true
      
      - name: Send Discord notifications
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          json_escape() {
            echo "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/\//\\\//g' -e 's/\n/\\n/g' -e 's/\r/\\r/g' -e 's/\t/\\t/g'
          }
          
          FILES_LIST="${{ steps.changed-files.outputs.all_changed_files }}"
          
          IFS=' ' read -ra FILES_ARRAY <<< "$FILES_LIST"
          
          REPO_NAME=$(json_escape "${{ github.repository }}")
          BRANCH_NAME=$(json_escape "${{ github.ref_name }}")
          AUTHOR_NAME=$(json_escape "${{ github.actor }}")
          
          for file_path in "${FILES_ARRAY[@]}"; do
            if [[ -n "$file_path" ]]; then
              FILENAME=$(json_escape "$(basename "$file_path")")
              FILEPATH_ESCAPED=$(json_escape "$file_path")
              
              REPO_URL="https://github.com/${{ github.repository }}"
              FILE_URL="$REPO_URL/blob/${{ github.ref_name }}/$file_path"
              
              TITLE="$FILENAME"
              
              DESCRIPTION=""
              TIMESTAMP=""
              
              if [[ "${{ github.event_name }}" == "push" ]]; then
                FULL_COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
                COMMIT_TITLE=$(echo "$FULL_COMMIT_MESSAGE" | head -n1)
                COMMIT_DESCRIPTION=$(echo "$FULL_COMMIT_MESSAGE" | tail -n+2 | sed '/^$/d')
                
                if [[ -n "$COMMIT_DESCRIPTION" ]]; then
                  DESCRIPTION="**$COMMIT_TITLE**\n\n$COMMIT_DESCRIPTION"
                else
                  DESCRIPTION="**$COMMIT_TITLE**"
                fi
                
                TIMESTAMP="${{ github.event.head_commit.timestamp }}"
              fi 
              
              if [[ -z "$TIMESTAMP" ]]; then
                TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              fi
              
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{
                    \"content\": \"ðŸ—£ Update in $REPO_NAME!\",
                    \"embeds\": [{
                      \"title\": \"[$TITLE]($FILE_URL)\",
                      \"description\": \"$DESCRIPTION\",
                      \"color\": 10181046,
                      \"fields\": [
                        {\"name\": \"Branch\", \"value\": \"$BRANCH_NAME\", \"inline\": true},
                        {\"name\": \"Author\", \"value\": \"$AUTHOR_NAME\", \"inline\": true}
                      ],
                      \"timestamp\": \"$TIMESTAMP\"
                    }]
                  }" \
                   $DISCORD_WEBHOOK_URL || echo "Failed to send notification for $file_path"
            fi 
          done 
